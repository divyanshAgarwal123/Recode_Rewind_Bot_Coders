// crops.min.js
(function(){document.addEventListener('DOMContentLoaded',async()=>{const container=document.getElementById('prices-container');if(!container)return;function err(m){container.innerHTML=`<p class="text-red-500">${m}</p>`}try{if(typeof d3==='undefined'){err('D3 not loaded');return}const path='./crops.csv'+(location.protocol==='file:'?('?v='+Date.now()):'');const raw=await d3.csv(path);if(!raw||!raw.length){err('No data in CSV');return}const data=raw.map(d=>({...d,Price:+d.Price,Date:new Date(d.Date)}));const groups=d3.group(data,d=>d.Crop);const latest=[];for(const [crop,rows]of groups){const sorted=rows.slice().sort((a,b)=>a.Date-b.Date);const last=sorted[sorted.length-1];const prev=sorted[sorted.length-2];const change=prev&&prev.Price?last.Price-prev.Price:0;const pct=prev&&prev.Price?(change/prev.Price)*100:0;latest.push({crop,last,prev,change,pct})}container.innerHTML='';latest.forEach(item=>{const up=item.pct>=0,arrow=up?'▲':'▼',color=up?'text-green-400':'text-red-400',price=item.last.Price.toFixed(2),dateStr=item.last.Date.toLocaleDateString(),pctStr=`${up?'+':''}${item.pct.toFixed(1)}%`,changeStr=`${up?'+':''}${item.change.toFixed(2)}`;container.insertAdjacentHTML('beforeend',`<div class="bg-gray-800/50 p-6 rounded-2xl border border-white/10 hover:border-green-500/40 transition"><div class="flex items-start justify-between"><h3 class="font-bold text-lg text-white">${item.crop}</h3><span class="text-xs px-2 py-1 rounded-full bg-white/5 text-gray-300 border border-white/10">Latest</span></div><div class="mt-3 flex items-baseline space-x-2"><p class="font-mono text-2xl font-semibold ${color}">₹${price}</p><span class="text-sm ${color}">${arrow} ${pctStr}</span></div><p class="text-gray-400 text-xs mt-1">Change: <span class="${color}">${changeStr}</span> since last month</p><p class="text-gray-400 text-xs mt-2">as of ${dateStr}</p></div>`)});}catch(e){console.error(e);err('Failed to load prices')}})})();