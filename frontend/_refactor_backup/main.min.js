// main.min.js
(function(){document.addEventListener('DOMContentLoaded',()=>{const l=document.getElementById('location'),t=document.getElementById('temperature'),w=document.getElementById('weather'),f=document.getElementById('forecast');const s=['Mumbai','Delhi','Bangalore','Kolkata','Chennai','Hyderabad','Pune','Ahmedabad','Jaipur','Lucknow'];const c={Sunny:'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>',"Partly Cloudy":'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22a7 7 0 0 0 4.9-2.1L12 15l-4.9 4.9A7 7 0 0 0 12 22z"/><path d="M17.2 15.2a4.6 4.6 0 0 0-3.5-3.5C14.5 11.2 16 9.2 16 7a5 5 0 0 0-10 0c0 2.2 1.5 4.2 2.3 4.7a4.6 4.6 0 0 0-3.5 3.5H1v1h22v-1h-5.8z"/></svg>',Cloudy:'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/></svg>',Rainy:'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 13v8"/><path d="M12 13v8"/><path d="M8 13v8"/><path d="M20 17.5a2.5 2.5 0 0 0-2.24-2.45c0-2.5-1.82-4.55-4.26-4.55-2.31 0-4.11 1.84-4.25 4.23A2.5 2.5 0 0 0 4 17.5Z"/></svg>',"Chance of Storms":'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/><path d="m10.72 11.5-3.22 6.5 6-3-3.22-6.5-2.56 3Z"/></svg>'};const k=Object.keys(c);const rc=s[Math.floor(Math.random()*s.length)],rt=Math.floor(Math.random()*25)+5,rw=k[Math.floor(Math.random()*k.length)];l&&(l.textContent=rc);t&&(t.textContent=`${rt}°C`);w&&(w.innerHTML=`${c[rw]} <span class="ml-2">${rw}</span>`,w.classList.add('flex','items-center'));if(f){f.innerHTML='';for(let i=1;i<=3;i++){const d=new Date();d.setDate(d.getDate()+i);const dn=d.toLocaleDateString('en-US',{weekday:'short'}),fwKey=k[Math.floor(Math.random()*k.length)],ft=rt-Math.floor(Math.random()*5)+2;f.insertAdjacentHTML('beforeend',`<div class="flex items-center justify-between text-sm"><span class="text-gray-400">${dn}</span>${c[fwKey]}<span class="font-medium text-white">${ft}°C</span></div>`);}}const hst=document.getElementById('health-status-text'),hb=document.getElementById('health-bar'),fa=document.getElementById('field-address'),fs=document.getElementById('field-size');const hl={Critical:{p:'10%',c:'bg-red-600'},Poor:{p:'30%',c:'bg-yellow-500'},Fair:{p:'50%',c:'bg-yellow-400'},Good:{p:'75%',c:'bg-green-400'},Excellent:{p:'100%',c:'bg-green-500'}},hk=Object.keys(hl),addrs=['123 Green Valley, Punjab','456 Harvest Lane, Haryana','789 Farm Road, Uttar Pradesh','101 Fertile Field, Madhya Pradesh','212 Orchard Ave, Maharashtra'];const rhk=hk[Math.floor(Math.random()*hk.length)],ra=addrs[Math.floor(Math.random()*addrs.length)],rs=(Math.random()*20+5).toFixed(1);hst&&(hst.textContent=rhk);hb&&(hb.style.width=hl[rhk].p,hb.className=`h-2.5 rounded-full ${hl[rhk].c}`);fa&&(fa.textContent=ra);fs&&(fs.textContent=`${rs} hectares`);const pfp=document.getElementById('farmer-pfp'),fn=document.getElementById('farmer-name'),fid=document.getElementById('farmer-id'),wh=document.getElementById('welcome-header');const farmerName='Zubin Patnaik',farmerId=`WAK-${Math.random().toString(36).substring(2,9).toUpperCase()}`;pfp&&(pfp.src='1741538149835.jpg');fn&&(fn.textContent=farmerName);fid&&(fid.textContent=`ID: ${farmerId}`);wh&&(wh.textContent=`Welcome, ${farmerName}`);const up=document.getElementById('file-upload');up&&up.addEventListener('change',e=>{const f=e.target.files[0];f&&alert(`You selected: ${f.name}`)});const headerSubtitle=document.getElementById('header-subtitle'),colors=['#34d399','#818cf8','#a78bfa','#f87171','#fbbf24','#06b6d4','#f59e0b','#8b5cf6','#ec4899','#10b981'],ticker=document.getElementById('crop-ticker'),tickerWrap=document.getElementById('crop-ticker-wrap');setTimeout(()=>{const canvas=document.getElementById('lastYearChart');if(!canvas||!canvas.getContext){headerSubtitle&&(headerSubtitle.textContent='Chart canvas not found');return;}const ctx=canvas.getContext('2d');if(typeof Chart==='undefined'){headerSubtitle&&(headerSubtitle.textContent='Chart library not loaded');return;}let chart=new Chart(ctx,{type:'line',data:{labels:[],datasets:[]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:true,position:'top',align:'start',labels:{color:'#9ca3af',font:{family:"'Poppins', sans-serif",size:11},usePointStyle:true,pointStyle:'circle',boxWidth:8,boxHeight:8,padding:12},maxHeight:60}},elements:{line:{tension:.2,borderWidth:2},point:{radius:2,hitRadius:6,hoverRadius:4}},scales:{y:{beginAtZero:false,grid:{color:'rgba(107,114,128,0.3)'},ticks:{color:'#9ca3af',font:{size:11}},title:{display:true,text:'Price (₹ per Quintal)',color:'#9ca3af',font:{size:12}}},x:{grid:{display:false},ticks:{color:'#9ca3af',font:{size:11}}}},interaction:{mode:'index',intersect:false}}});function fallback(){return[{Crop:'Wheat',Date:new Date('2024-01-15'),Price:21.5},{Crop:'Wheat',Date:new Date('2024-03-15'),Price:21.8},{Crop:'Wheat',Date:new Date('2024-06-15'),Price:22.9},{Crop:'Wheat',Date:new Date('2024-09-15'),Price:23.0},{Crop:'Wheat',Date:new Date('2024-12-15'),Price:24.0},{Crop:'Rice',Date:new Date('2024-01-15'),Price:34.0},{Crop:'Rice',Date:new Date('2024-03-15'),Price:34.2},{Crop:'Rice',Date:new Date('2024-06-15'),Price:35.5},{Crop:'Rice',Date:new Date('2024-09-15'),Price:35.8},{Crop:'Rice',Date:new Date('2024-12-15'),Price:37.0},{Crop:'Potato',Date:new Date('2024-01-15'),Price:17.0},{Crop:'Potato',Date:new Date('2024-03-15'),Price:17.2},{Crop:'Potato',Date:new Date('2024-06-15'),Price:19.0},{Crop:'Potato',Date:new Date('2024-09-15'),Price:19.2},{Crop:'Potato',Date:new Date('2024-12-15'),Price:21.0},{Crop:'Sugarcane',Date:new Date('2024-01-15'),Price:3.1},{Crop:'Sugarcane',Date:new Date('2024-03-15'),Price:3.12},{Crop:'Sugarcane',Date:new Date('2024-06-15'),Price:3.25},{Crop:'Sugarcane',Date:new Date('2024-09-15'),Price:3.28},{Crop:'Sugarcane',Date:new Date('2024-12-15'),Price:3.4},{Crop:'Jowar',Date:new Date('2024-01-15'),Price:28.0},{Crop:'Jowar',Date:new Date('2024-03-15'),Price:28.2},{Crop:'Jowar',Date:new Date('2024-06-15'),Price:29.5},{Crop:'Jowar',Date:new Date('2024-09-15'),Price:29.8},{Crop:'Jowar',Date:new Date('2024-12-15'),Price:31.0},{Crop:'Maize',Date:new Date('2024-01-15'),Price:20.5},{Crop:'Maize',Date:new Date('2024-03-15'),Price:20.7},{Crop:'Maize',Date:new Date('2024-06-15'),Price:21.6},{Crop:'Maize',Date:new Date('2024-09-15'),Price:21.8},{Crop:'Maize',Date:new Date('2024-12-15'),Price:22.8},{Crop:'Barley',Date:new Date('2024-01-15'),Price:23.0},{Crop:'Barley',Date:new Date('2024-03-15'),Price:23.2},{Crop:'Barley',Date:new Date('2024-06-15'),Price:24.2},{Crop:'Barley',Date:new Date('2024-09-15'),Price:24.3},{Crop:'Barley',Date:new Date('2024-12-15'),Price:25.3},{Crop:'Soybean',Date:new Date('2024-01-15'),Price:48.0},{Crop:'Soybean',Date:new Date('2024-03-15'),Price:48.2},{Crop:'Soybean',Date:new Date('2024-06-15'),Price:50.0},{Crop:'Soybean',Date:new Date('2024-09-15'),Price:50.2},{Crop:'Soybean',Date:new Date('2024-12-15'),Price:52.0},{Crop:'Mustard',Date:new Date('2024-01-15'),Price:52.0},{Crop:'Mustard',Date:new Date('2024-03-15'),Price:52.3},{Crop:'Mustard',Date:new Date('2024-06-15'),Price:53.8},{Crop:'Mustard',Date:new Date('2024-09-15'),Price:53.9},{Crop:'Mustard',Date:new Date('2024-12-15'),Price:55.2},{Crop:'Gram',Date:new Date('2024-01-15'),Price:41.0},{Crop:'Gram',Date:new Date('2024-03-15'),Price:41.2},{Crop:'Gram',Date:new Date('2024-06-15'),Price:42.4},{Crop:'Gram',Date:new Date('2024-09-15'),Price:42.5},{Crop:'Gram',Date:new Date('2024-12-15'),Price:43.8}]}
function processData(data){if(!data||!data.length){headerSubtitle&&(headerSubtitle.textContent='No crop data available');return;}const sorted=data.slice().sort((a,b)=>a.Date-b.Date);const labelDates=Array.from(new Set(sorted.map(d=>new Date(d.Date.getFullYear(),d.Date.getMonth(),1).getTime()))).sort((a,b)=>a-b).map(ms=>new Date(ms));const labels=labelDates.map(dt=>dt.toLocaleString('default',{month:'short'}));const map=new Map();sorted.forEach(it=>{map.has(it.Crop)||map.set(it.Crop,[]);map.get(it.Crop).push(it)});const names=Array.from(map.keys());const datasets=names.map((n,i)=>{const cropData=map.get(n),byMonth=new Map();cropData.forEach(r=>{const k=new Date(r.Date.getFullYear(),r.Date.getMonth(),1).getTime();byMonth.set(k,r.Price)});const series=labelDates.map(dt=>byMonth.get(dt.getTime())||null),color=colors[i%colors.length];return{label:n,data:series,borderColor:color,backgroundColor:color+'20',tension:.2,spanGaps:true,pointRadius:3,pointHoverRadius:6,fill:false,borderWidth:2}});chart.data.labels=labels;chart.data.datasets=datasets;chart.update();headerSubtitle&&(headerSubtitle.textContent='CROP PRICE TRENDS (₹ per Quintal)');buildTicker(map)}function buildTicker(map){try{const latest=Array.from(map.entries()).map(([name,rows])=>{const s=rows.slice().sort((a,b)=>a.Date-b.Date);const last=s[s.length-1],prev=s[s.length-2];const pct=prev&&prev.Price?((last.Price-prev.Price)/prev.Price)*100:0;return{name,last:last.Price,pct}});const items=latest.map(it=>{const up=it.pct>=0,color=up?'text-green-400':'text-red-400',arrow=up?'▲':'▼',pct=`${up?'+':''}${it.pct.toFixed(1)}%`,price=`₹${Number(it.last).toFixed(2)}`;return`<span class="mx-8 ${color} font-semibold text-sm md:text-base tracking-wide">${it.name.toUpperCase()} ${arrow} ${pct} <span class="text-gray-300 font-normal ml-1">${price}</span></span>`});if(ticker){ticker.innerHTML=items.join('');let offset=tickerWrap?tickerWrap.clientWidth:0;const speed=1.2;function anim(){offset-=speed;ticker.style.transform=`translateX(${offset}px)`;const total=ticker.offsetWidth;if(offset+total<0){offset=tickerWrap?tickerWrap.clientWidth:0}requestAnimationFrame(anim)}anim()}}catch(e){console.warn('Ticker build failed',e)}}if(typeof d3!=='undefined'){const path='./crops.csv'+(location.protocol==='file:'?('?v='+Date.now()):'');d3.csv(path).then(raw=>{if(raw&&raw.length){const data=raw.map(d=>({Crop:d.Crop,Date:new Date(d.Date),Price:+d.Price}));processData(data)}else{processData(fallback())}}).catch(()=>processData(fallback()))}else{processData(fallback())}} ,100)})})();